{% extends "admin/base.html" %}

{% block page_title %}Certificate Management{% endblock %}
{% block header_title %}Certificate Management{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto bg-white rounded-lg shadow-md p-8">
    
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Pixie Viewer Certificates</h2>
        <div class="flex gap-3">
            <button onclick="createQuickCert()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold">
                ‚ö° Quick Certificate (This Device)
            </button>
            <button onclick="createDisplayCert()" class="btn-primary text-white px-4 py-2 rounded-lg">
                üñ•Ô∏è New Display Certificate
            </button>
            <button onclick="createSalesCert()" class="btn-primary text-white px-4 py-2 rounded-lg">
                üëî New Sales Certificate
            </button>
        </div>
    </div>

    <!-- Certificate Status Overview -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
            <h3 class="text-lg font-semibold text-green-800">Display Certificates</h3>
            <p class="text-3xl font-bold text-green-600" id="display-count">{{ display_certs|length }}</p>
            <p class="text-sm text-green-600">Long-term (5 years)</p>
        </div>
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <h3 class="text-lg font-semibold text-blue-800">Sales Certificates</h3>
            <p class="text-3xl font-bold text-blue-600" id="sales-count">{{ sales_certs|length }}</p>
            <p class="text-sm text-blue-600">Short-term (30 days)</p>
        </div>
        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
            <h3 class="text-lg font-semibold text-red-800">Expiring Soon</h3>
            <p class="text-3xl font-bold text-red-600" id="expiring-count">{{ expiring_count }}</p>
            <p class="text-sm text-red-600">Next 30 days</p>
        </div>
    </div>

    <!-- Active Certificates Table -->
    <div class="mb-8">
        <h3 class="text-xl font-semibold mb-4">Active Certificates</h3>
        <div class="overflow-x-auto">
            <table class="w-full border border-gray-300">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left">Name</th>
                        <th class="px-4 py-2 text-left">Type</th>
                        <th class="px-4 py-2 text-left">Issued</th>
                        <th class="px-4 py-2 text-left">Expires</th>
                        <th class="px-4 py-2 text-left">Status</th>
                        <th class="px-4 py-2 text-left">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cert in certificates %}
                    <tr class="border-t {% if cert.expires_soon %}bg-yellow-50{% endif %}">
                        <td class="px-4 py-2 font-mono">{{ cert.name }}</td>
                        <td class="px-4 py-2">
                            <span class="px-2 py-1 rounded text-xs font-semibold
                                {% if cert.type == 'display' %}bg-green-100 text-green-800
                                {% elif cert.type == 'sales' %}bg-blue-100 text-blue-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ cert.type|title }}
                            </span>
                        </td>
                        <td class="px-4 py-2">{{ cert.issued|strftime('%Y-%m-%d') }}</td>
                        <td class="px-4 py-2">{{ cert.expires|strftime('%Y-%m-%d') }}</td>
                        <td class="px-4 py-2">
                            {% if cert.expired %}
                                <span class="text-red-600 font-semibold">Expired</span>
                            {% elif cert.expires_soon %}
                                <span class="text-yellow-600 font-semibold">Expiring Soon</span>
                            {% else %}
                                <span class="text-green-600 font-semibold">Active</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-2">
                            <div class="flex gap-2">
                                <button onclick="downloadCert('{{ cert.name }}')" 
                                        class="text-blue-600 hover:text-blue-900 text-sm">Download</button>
                                <button onclick="revokeCert('{{ cert.name }}')" 
                                        class="text-red-600 hover:text-red-900 text-sm">Revoke</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Certificate Creation Forms -->
    <div id="create-display-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Create Display Certificate</h3>
            <form id="display-cert-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Display Name</label>
                    <input type="text" name="display_name" class="w-full border rounded px-3 py-2" 
                           placeholder="e.g., main-entrance-display" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Location</label>
                    <input type="text" name="location" class="w-full border rounded px-3 py-2" 
                           placeholder="e.g., Main Entrance" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal('create-display-modal')" 
                            class="px-4 py-2 text-gray-600 hover:text-gray-900">Cancel</button>
                    <button type="submit" class="btn-primary text-white px-4 py-2 rounded">Create Certificate</button>
                </div>
            </form>
        </div>
    </div>

    <div id="create-sales-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">Create Sales Certificate</h3>
            <form id="sales-cert-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Staff Name</label>
                    <input type="text" name="staff_name" class="w-full border rounded px-3 py-2" 
                           placeholder="e.g., john-doe" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Duration (days)</label>
                    <select name="duration" class="w-full border rounded px-3 py-2" required>
                        <option value="7">1 Week</option>
                        <option value="30" selected>1 Month</option>
                        <option value="90">3 Months</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal('create-sales-modal')" 
                            class="px-4 py-2 text-gray-600 hover:text-gray-900">Cancel</button>
                    <button type="submit" class="btn-primary text-white px-4 py-2 rounded">Create Certificate</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Certificate Modal -->
    <div id="create-quick-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">‚ö° Generate Quick Certificate</h3>
            <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded">
                <p class="text-sm text-green-800">
                    <strong>Current Device:</strong> This will generate a certificate for the device you're using right now.
                    Perfect for demos, emergency access, or quick testing.
                </p>
            </div>
            <form id="quick-cert-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Device Name</label>
                    <input type="text" name="device_name" class="w-full border rounded px-3 py-2" 
                           placeholder="e.g., sales-laptop, demo-ipad" required>
                    <p class="text-xs text-gray-500 mt-1">Used for identification in logs</p>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Purpose</label>
                    <select name="purpose" class="w-full border rounded px-3 py-2" required>
                        <option value="sales-demo">Sales Demo</option>
                        <option value="emergency-access">Emergency Access</option>
                        <option value="testing">Testing</option>
                        <option value="trade-show">Trade Show</option>
                        <option value="client-meeting">Client Meeting</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Duration</label>
                    <select name="duration" class="w-full border rounded px-3 py-2" required>
                        <option value="1">1 Day</option>
                        <option value="7" selected>1 Week</option>
                        <option value="30">1 Month</option>
                        <option value="90">3 Months (Max)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Certificate will expire automatically</p>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal('create-quick-modal')" 
                            class="px-4 py-2 text-gray-600 hover:text-gray-900">Cancel</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                        Generate & Download
                    </button>
                </div>
            </form>
        </div>
    </div>

</div>

<script>
function createDisplayCert() {
    document.getElementById('create-display-modal').classList.remove('hidden');
}

function createSalesCert() {
    document.getElementById('create-sales-modal').classList.remove('hidden');
}

function createQuickCert() {
    document.getElementById('create-quick-modal').classList.remove('hidden');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

async function downloadCert(certName) {
    try {
        const response = await fetch(`/admin/certificates/${certName}/download`);
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${certName}.p12`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    } catch (error) {
        alert('Failed to download certificate');
    }
}

async function revokeCert(certName) {
    if (!confirm(`Revoke certificate for ${certName}? This action cannot be undone.`)) return;
    
    try {
        const response = await fetch(`/admin/certificates/${certName}/revoke`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            }
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to revoke certificate');
        }
    } catch (error) {
        alert('Error revoking certificate');
    }
}

// Form submissions
document.getElementById('display-cert-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('/admin/certificates/create-display', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to create certificate');
        }
    } catch (error) {
        alert('Error creating certificate');
    }
});

document.getElementById('sales-cert-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('/admin/certificates/create-sales', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Failed to create certificate');
        }
    } catch (error) {
        alert('Error creating certificate');
    }
});

// Quick certificate form submission
document.getElementById('quick-cert-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const submitButton = e.target.querySelector('button[type="submit"]');
    
    // Show loading state
    const originalText = submitButton.textContent;
    submitButton.textContent = 'Generating...';
    submitButton.disabled = true;
    
    try {
        const response = await fetch('/admin/certificates/generate-quick', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            // Show success message with download info
            const modal = document.getElementById('create-quick-modal');
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4 text-green-600">‚úÖ Certificate Generated!</h3>
                    <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded">
                        <p class="text-sm"><strong>Certificate:</strong> ${result.certificate_name}</p>
                        <p class="text-sm"><strong>Password:</strong> <code class="bg-gray-100 px-1 rounded">${result.password}</code></p>
                        <p class="text-sm"><strong>Expires:</strong> ${result.expires_days} days</p>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">
                            <strong>Next Steps:</strong>
                        </p>
                        <ol class="text-sm text-gray-600 list-decimal list-inside">
                            <li>Download the certificate file below</li>
                            <li>Install it on this device</li>
                            <li>Visit the Pixie Viewer with HTTPS</li>
                        </ol>
                    </div>
                    <div class="flex justify-between gap-3">
                        <button onclick="downloadCertificate('${result.certificate_name}')" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded flex-1">
                            üì• Download Certificate
                        </button>
                        <button onclick="closeModal('create-quick-modal'); location.reload();" 
                                class="px-4 py-2 text-gray-600 hover:text-gray-900">Done</button>
                    </div>
                </div>
            `;
        } else {
            alert(result.error || 'Failed to generate certificate');
            submitButton.textContent = originalText;
            submitButton.disabled = false;
        }
    } catch (error) {
        alert('Error generating certificate');
        submitButton.textContent = originalText;
        submitButton.disabled = false;
    }
});

function downloadCertificate(certName) {
    const a = document.createElement('a');
    a.href = `/admin/certificates/${certName}/download`;
    a.download = `${certName}.p12`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
</script>
{% endblock %}